# Configuration

This guide explains all environment variables and configuration options for the NestJS Multi-Tenant API.

## Environment Files

The application uses environment variables for configuration, loaded from a `.env` file.

### Setup

1. Copy the example file:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` with your configuration

3. Restart the application to apply changes

## Required Configuration

### Database

```bash
DATABASE_HOST=mylegitech_postgres
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=mylegitech
DATABASE_SSL=false
```

PostgreSQL connection settings:
- `DATABASE_HOST`: Database server hostname (e.g., `localhost` or `mylegitech_postgres` for Docker)
- `DATABASE_PORT`: PostgreSQL port (default: `5432`)
- `DATABASE_USER`: PostgreSQL username
- `DATABASE_PASSWORD`: PostgreSQL password
- `DATABASE_NAME`: Database name
- `DATABASE_SSL`: Enable SSL connection (`true` or `false`)

**Example for Local Development**:
```bash
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=mylegitech
DATABASE_SSL=false
```

**Production**: Use connection pooling and SSL:
```bash
DATABASE_HOST=production-db.example.com
DATABASE_PORT=5432
DATABASE_USER=api_user
DATABASE_PASSWORD=strong-password-here
DATABASE_NAME=production_db
DATABASE_SSL=true
```

### Keycloak Authentication

**⚠️ IMPORTANT**: This application uses **Pure Keycloak architecture**. JWT tokens are **NOT** generated by the API.

```bash
KEYCLOAK_REALM=mylegitech
KEYCLOAK_AUTH_SERVER_URL=http://localhost:8090
KEYCLOAK_CLIENT_ID=mylegitech-api
KEYCLOAK_CLIENT_SECRET=your-client-secret
KEYCLOAK_JWKS_URI=http://localhost:8090/realms/mylegitech/protocol/openid-connect/certs
```

- `KEYCLOAK_REALM`: Keycloak realm name
- `KEYCLOAK_AUTH_SERVER_URL`: Keycloak server URL
- `KEYCLOAK_CLIENT_ID`: Client ID for the API (must match Keycloak client configuration)
- `KEYCLOAK_CLIENT_SECRET`: Client secret from Keycloak (found in "Credentials" tab)
- `KEYCLOAK_JWKS_URI`: JWKS endpoint for JWT signature validation

**How to Get Client Secret**:
1. Go to Keycloak Admin Console: http://localhost:8090
2. Login with admin credentials
3. Select your realm (e.g., `mylegitech`)
4. Go to "Clients" → Select your client (e.g., `mylegitech-api`)
5. Go to "Credentials" tab
6. Copy the "Client secret" value

**Production Configuration**:
```bash
KEYCLOAK_REALM=production
KEYCLOAK_AUTH_SERVER_URL=https://auth.yourdomain.com
KEYCLOAK_CLIENT_ID=production-api
KEYCLOAK_CLIENT_SECRET=production-secret-here
KEYCLOAK_JWKS_URI=https://auth.yourdomain.com/realms/production/protocol/openid-connect/certs
```

### Application

```bash
PORT=3000
NODE_ENV=development
CORS_ORIGIN=http://localhost:5173
```

- `PORT`: Server port (default: `3000`)
- `NODE_ENV`: Environment mode (`development` | `production` | `test`)
- `CORS_ORIGIN`: Allowed origin for CORS (comma-separated for multiple origins)

**Production CORS**:
```bash
CORS_ORIGIN=https://yourdomain.com,https://www.yourdomain.com
```

## Email Service (Mailjet)

```bash
MAILJET_API_KEY=your-mailjet-api-key
MAILJET_SECRET_KEY=your-mailjet-secret-key
MAILJET_SENDER_EMAIL=noreply@yourdomain.com
MAILJET_SENDER_NAME=Your App Name
INVITATION_BASE_URL=http://localhost:5173/accept-invitation
```

- `MAILJET_API_KEY`: Mailjet API key (from Mailjet dashboard)
- `MAILJET_SECRET_KEY`: Mailjet secret key
- `MAILJET_SENDER_EMAIL`: Verified sender email address
- `MAILJET_SENDER_NAME`: Display name for sent emails
- `INVITATION_BASE_URL`: Frontend URL for invitation acceptance

**Setup**:
1. Sign up at [mailjet.com](https://www.mailjet.com)
2. Get API credentials from dashboard
3. Verify your sender email address
4. Update `.env` with credentials

**Alternative**: The application uses Brevo (formerly Sendinblue) API keys which are compatible with Mailjet format.

## Rate Limiting

```bash
THROTTLE_TTL=60
THROTTLE_LIMIT=100
```

- `THROTTLE_TTL`: Time window in seconds (default: 60)
- `THROTTLE_LIMIT`: Max requests per time window (default: 100)

This applies to all endpoints globally.

**Production**: Adjust based on expected traffic:
```bash
THROTTLE_TTL=60
THROTTLE_LIMIT=200  # Higher limit for production
```

## Error Tracking (Sentry)

```bash
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id
SENTRY_RELEASE=nestjs-api@1.0.0
SENTRY_TRACES_SAMPLE_RATE=1.0
SENTRY_PROFILES_SAMPLE_RATE=0.0
```

- `SENTRY_DSN`: Sentry project DSN (Data Source Name)
- `SENTRY_RELEASE`: Release version for tracking deployments
- `SENTRY_TRACES_SAMPLE_RATE`: Performance monitoring sample rate (0.0 to 1.0)
- `SENTRY_PROFILES_SAMPLE_RATE`: Profiling sample rate (0.0 to 1.0)

**Recommended Production Settings**:
```bash
SENTRY_DSN=https://...@sentry.io/project-id
SENTRY_TRACES_SAMPLE_RATE=0.1  # 10% sampling to reduce costs
SENTRY_PROFILES_SAMPLE_RATE=0.0  # Disable profiling in production
```

**Setup**:
1. Sign up at [sentry.io](https://sentry.io)
2. Create a new project
3. Copy the DSN from project settings
4. Update `.env`

See [Sentry Integration Guide](../integrations/sentry.md) for more details.

## Yousign (Electronic Signature)

```bash
YOUSIGN_API_KEY=your-yousign-api-key
YOUSIGN_ENVIRONMENT=sandbox
```

- `YOUSIGN_API_KEY`: Yousign API key
- `YOUSIGN_ENVIRONMENT`: `sandbox` or `production`

**Optional** - Only required if you're using electronic signature features.

**Setup**:
1. Sign up at [yousign.com](https://yousign.com)
2. Get API key from dashboard
3. Use `sandbox` for testing, `production` for live signatures

See [Yousign Integration Guide](../integrations/yousign.md) for usage examples.

## AR24 (Registered Mail)

```bash
AR24_TOKEN=your-ar24-token
AR24_PRIVATE_KEY=your-ar24-private-key
AR24_ENVIRONMENT=sandbox
```

- `AR24_TOKEN`: AR24 authentication token
- `AR24_PRIVATE_KEY`: AR24 private key for request signing
- `AR24_ENVIRONMENT`: `sandbox` or `production`

**Optional** - Only required if you're using registered mail features.

**Setup**:
1. Sign up at [ar24.fr](https://www.ar24.fr)
2. Get credentials from dashboard
3. Use `sandbox` for testing, `production` for live mails

See [AR24 Integration Guide](../integrations/ar24.md) for usage examples.

## Configuration Validation

The application uses [Joi](https://joi.dev) for environment variable validation (see `src/config/validation.schema.ts`).

If required variables are missing or invalid, the application will fail to start with a clear error message:

```
[Nest] ERROR [ConfigService]
  Configuration validation error:
  "KEYCLOAK_REALM" is required
```

## Environment-Specific Configs

### Development

```bash
NODE_ENV=development
PORT=3000
CORS_ORIGIN=http://localhost:5173
SENTRY_TRACES_SAMPLE_RATE=1.0  # 100% sampling for debugging

# Keycloak (local)
KEYCLOAK_REALM=mylegitech
KEYCLOAK_AUTH_SERVER_URL=http://localhost:8090
KEYCLOAK_CLIENT_ID=mylegitech-api
KEYCLOAK_CLIENT_SECRET=development-secret
KEYCLOAK_JWKS_URI=http://localhost:8090/realms/mylegitech/protocol/openid-connect/certs
```

### Production

```bash
NODE_ENV=production
PORT=3000
CORS_ORIGIN=https://yourdomain.com
SENTRY_TRACES_SAMPLE_RATE=0.1  # 10% sampling to reduce costs
THROTTLE_LIMIT=200  # Higher limit for production traffic

# Keycloak (production)
KEYCLOAK_REALM=production
KEYCLOAK_AUTH_SERVER_URL=https://auth.yourdomain.com
KEYCLOAK_CLIENT_ID=production-api
KEYCLOAK_CLIENT_SECRET=strong-production-secret
KEYCLOAK_JWKS_URI=https://auth.yourdomain.com/realms/production/protocol/openid-connect/certs

# Production database with SSL
DATABASE_HOST=production-db.example.com
DATABASE_PORT=5432
DATABASE_USER=api_user
DATABASE_PASSWORD=strong-password-here
DATABASE_NAME=production_db
DATABASE_SSL=true
```

### Testing

```bash
NODE_ENV=test
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=mylegitech_test
```

## Configuration Service

Environment variables are accessed via NestJS's `ConfigService`:

```typescript
import { ConfigService } from '@nestjs/config';

constructor(private configService: ConfigService) {}

const port = this.configService.get<number>('port');
const keycloakRealm = this.configService.get<string>('keycloak.realm');
```

**Important**: Never access `process.env` directly. Always use `ConfigService` for type safety and validation.

## Removed Configuration (Pure Keycloak Architecture)

The following environment variables are **NO LONGER USED** in Pure Keycloak architecture:

- ❌ `JWT_SECRET` - JWT tokens generated by Keycloak, not the API
- ❌ `JWT_EXPIRATION` - Token expiration configured in Keycloak
- ❌ `REFRESH_TOKEN_SECRET` - Refresh tokens managed by Keycloak
- ❌ `REFRESH_TOKEN_EXPIRATION` - Refresh token expiration configured in Keycloak

**Migration Note**: If migrating from JWT-based auth, remove these variables from your `.env` file.

## Next Steps

- [Quick Start](./quick-start.md) - Get the API running
- [First Steps](./first-steps.md) - Make your first API calls
- [Authentication Architecture](../architecture/authentication.md) - Learn about Keycloak integration
